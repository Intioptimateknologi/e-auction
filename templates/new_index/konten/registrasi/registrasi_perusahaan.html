{% extends 'new_index/base1.html' %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="/static/css/koGrid.css" >
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css" />
{% endblock %}

{% block tambah_css %}
<style>
    .gridStyle {
        border: 1px solid rgb(255, 255, 255);
        width: 100%; 
        height: 300px;
        float: left;
    }
    .KgTopPanel{
        background-color: white;
    }
    .KgFooterPanel{
        background-color: white;
    }
    .kgRow.Even{
        background-color: #edf5fd;
    }
    .KgRow.Even.selected{
	background-color: rgb(189, 208, 203);
	}

    .sd-container-modern{
        margin: 0px;
    }

    .sd-body--responsive .sd-page.sd-page__empty-header {
        padding-top: calc(3 * var(--base-unit, 8px));
    }

    .navbar-expand{
        flex-wrap: nowrap;
        display: flex;
        justify-content: space-between;
    }
    a{
        text-decoration:none;
    }
    .sd-page.sd-body__page.sd-page__empty-header{
        background-color: white;
        padding: 0px;
    }
    .sd-action-bar.sd-footer.sd-body__navigation.sd-clearfix{
        display: none;
    }

    .sd-row.sd-clearfix.sd-page__row.sd-row--multiple{
        margin: 0px !important;
    }
</style>
{% endblock  %}

{% block navbar %}
{% include 'new_index/parts/navbar_kosong.html' %}
{% endblock %}

{% block konten_isi %}
<div class="container" style="padding-top: 0px;">
    <div class="row">
        <div class="col">
            <h1 style="color: rgb(0,114,228);font-size: 24px;font-weight: bold;">Registrasi Bidder<br></h1>
            <hr>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="card card-primary card-outline" id="management_block">
                <div class="card-header" style="background-color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; align-content: center; flex-wrap: nowrap; flex-direction: row;">
                        <div class="h4 float-start">List Bidder</div>
                        <button type="button" id="tambah_data" class="btn btn-secondary float-end" style="background-color: #fff;color: #007bff;border-color: #007bff; font-size:14px;"><i class="fa-solid fa-plus-circle"></i> Tambah Baru</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="bidderlist" class="gridStyle" data-bind="koGrid: gridOptions"></div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}


{% block footer %}
{% include 'new_index/parts/footer_dashboard.html' %}
{% endblock %}

{% block modal %}

    <!-- datatable -->
    <div id="myModal2" class="modal fade" role="dialog" >
        <div class="modal-dialog modal-xl">
            <!-- Modal content -->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title2">judul</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <table id="bidderlist2" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Name Pengguna</th>
                                <th>Nama Perusahaan</th>
                                <th>Jenis Penyelengara</th>
                                <th>Status</th>
                                <th>Link File</th>
                                <th width="60px">Aksi</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- modal -->
    <div id="myModal" class="modal fade" role="dialog" >
        <div class="modal-dialog modal-xl">
            <!-- Modal content -->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">judul</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="form_survey"></div>

                    <div style="display: flex; justify-content: flex-end;">
                        <button type="button" class="btn btn-danger" id="tombol_batal" onclick="batal()">Batal</button>
                        <button type="button" class="btn btn-primary ml-3" id="tombol_simpan" onclick="simpan()">Simpan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>



{% endblock %}

{% block script %}
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
    var var_survey;
    var var_survey_edit;
    var var_perwakilan;
    var var_data_perwakilan;
    let id_global;
    var tricky_tombol_modal;
    var list_perwakilan_user;
    var data_perwakilan;

    $(document).ready(function() {
        
        function mainVm(){
            var self = this; 
            this.myData = ko.observableArray([]);
        
            this.filterOptions = {
                filterText: ko.observable(""),
                useExternalFilter: true
            };
            this.mySelectedData = ko.observableArray([]);

            this.pagingOptions = {
                pageSizes: ko.observableArray([5, 10, 15]),
                pageSize: ko.observable(5),
                totalServerItems: ko.observable(0),
                currentPage: ko.observable(1)     
            };
        
            this.setPagingData = function(data, page, pageSize){	
                var data_mentah = data.results;
                var data_array = [];

                function myFunction(item, index) {
                    var test = {
                        "index": index+1,
                        "id": item.id,
                        "isactive": manipulasi_data_status(item.isactive),
                        "alamat_perusahaan": item.alamat_perusahaan,
                        "email_perusahaan": item.email_perusahaan,
                        "jenis_penyelenggara": manipulasi_data_jenis(item.jenis_penyelenggara),
                        "nama_perusahaan": item.nama_perusahaan,
                        "nib_perusahaan": item.nib_perusahaan,
                        "npwp_perusahaan": item.npwp_perusahaan,
                        "surat_kuasa": item.surat_kuasa,
                        "telp_perusahaan": item.telp_perusahaan,
                    }
                    data_array.push(test);
                }

                function manipulasi_data_status(data_status){
                    if (data_status == true) {
                        return "Aktif";
                    } else {
                        return "Nonaktif";
                    }
                }

                function manipulasi_data_jenis(data_jenis){
                    switch(data_jenis) {
                        case "JSB":
                            return "Jaringan Bergerak Seluler";
                            break;
                        case "JKS":
                            return "Jaringan Tetap Lokal Packet Switched";
                            break;
                        default:
                            return "unknown";
                    }
                }

                data_mentah.forEach(myFunction);
                self.myData(data_array);
                self.pagingOptions.totalServerItems(data.count);
            };
        
            this.getPagedDataAsync = function (pageSize, page, searchText) {
                setTimeout(function () {
                    var data;
                    if (searchText) {
                        var ft = searchText.toLowerCase();
                        $.getJSON('/userman/api/v1/bidder/?format=json&limit=' + pageSize +'&nama_perusahaan='+ ft, function (largeLoad) {		
                            // data = largeLoad.filter(function(item) {
                            //     return JSON.stringify(item).toLowerCase().indexOf(ft) != -1;
                            // });
                            self.setPagingData(largeLoad,page,pageSize);
                        });            
                    } else {
                        $.getJSON('/userman/api/v1/bidder/?format=json&limit=' + pageSize + '&offset=' + (page-1)*pageSize, function (largeLoad) {
                            self.setPagingData(largeLoad,page,pageSize);
                        });
                    }
                }, 100);
            };

            self.filterOptions.filterText.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });   

            self.pagingOptions.pageSizes.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });
            self.pagingOptions.pageSize.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });
            self.pagingOptions.totalServerItems.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });
            self.pagingOptions.currentPage.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });
        
            self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage());
            this.gridOptions = {
                data: self.myData,
                enablePaging: true,
                displaySelectionCheckbox: false,
                showColumnMenu: false,
                pagingOptions: self.pagingOptions,
                filterOptions: self.filterOptions,
                selectedItems: self.mySelectedData,
                columnDefs: [
                    {field: 'nama_perusahaan', displayName: 'Nama Perusahaan'},
                    {field: 'alamat_perusahaan', displayName: 'Alamat'},
                    // {field: 'jenis_penyelenggara', displayName: 'Jenis Penyelenggara'},
                    {field: 'telp_perusahaan', displayName: 'Telp'},
                    {field: 'email_perusahaan', displayName: 'Email'},
                    {field: 'nib_perusahaan', displayName: 'NIB'},
                    // {field: 'sk_pengangkatan', displayName: 'File Link', cellTemplate:'<div style="display: flex; justify-content: center;"><button class="download badge bg-primary mr-1" data-bind=\"attr: {\'id\': $data.getProperty($parent)}\" value="download" style="border-color:white;"><i class="fa-solid fa-file"></i></button></div>'},
                    // {field: 'isactive', displayName: 'Status'},
                    {field: 'id', displayName: 'Perwakilan', cellTemplate:'<button class="tambah_perwakilan badge bg-success mr-1" data-bs-toggle="tooltip" data-bs-placement="top" data-bind=\"attr: {\'id\': $data.getProperty($parent)}\"><i class="fa fa-plus"></i></button>&nbsp;&nbsp;<button class="lihat_perwakilan badge bg-info mr-1" data-bs-toggle="tooltip" data-bs-placement="top" data-bind=\"attr: {\'id\': $data.getProperty($parent)}\"><i class="fa fa-eye"></i></button>'},
                    {field: 'id', displayName: 'Action', cellTemplate:'<button class="edit badge bg-primary mr-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit" data-bind=\"attr: {\'id\': $data.getProperty($parent)}\"><i class="fa fa-pen"></i></button>&nbsp;&nbsp;<button class="delete badge bg-danger mr-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete" data-bind=\"attr: {\'id\': $data.getProperty($parent)}\"><i class="fa fa-eraser"></i></button>'}
                ],
                afterSelectionChange: function(){ 
                    console.log(self.mySelectedData());
                }
            };	
        };
        
        var myvm = new mainVm();
        ko.applyBindings(myvm, document.getElementById("management_block"));
        
        //nambah perusahaan
        var json = {
            "title": "Pertanyaan",
            "logoPosition": "right",
            "pages": [
                {
                "name": "page1",
                "elements": [
                {
                "type": "text",
                "name": "nama_perusahaan",
                "title": "Nama Perusahaan",
                "hideNumber": true,
                "isRequired": true,
                "titleLocation": "top" 
                },
                {
                "type": "text",
                "name": "email_perusahaan",
                "startWithNewLine": false,
                "inputType": "email",
                "title": "Email Perusahaan",
                "hideNumber": true,
                "isRequired": true,
                "titleLocation": "top" 
                },
                {
                "type": "text",
                "name": "alamat_perusahaan",
                "title": "Alamat Perusahaan",
                "hideNumber": true,
                "isRequired": true,
                "titleLocation": "top" 
                },
                {
                "type": "dropdown",
                "name": "jenis_penyelenggara",
                "title": "Jenis Penyelengara",
                "hideNumber": true,
                "isRequired": true,
                "titleLocation": "top",
                "choices": [
                {
                "value": "JSB",
                "text": "Jaringan Bergerak Seluler"
                },
                {
                "value": "JKS",
                "text": "Jaringan Tetap Lokal Packet Switched"
                },
                ]
                },
                {
                "type": "text",
                "name": "telp_perusahaan",
                "title": "No Telepon Perusahaan",
                "startWithNewLine": false,
                "hideNumber": true,
                "isRequired": true,
                "titleLocation": "top",
                },
                {
                "type": "text",
                "name": "npwp_perusahaan",
                "title": "NPWP",
                "hideNumber": true,
                "isRequired": true,
                "titleLocation": "top",
                },
                {
                "type": "text",
                "name": "nib_perusahaan",
                "title": "NIB Perusahaan",
                "startWithNewLine": false,
                "hideNumber": true,
                "isRequired": true,
                "titleLocation": "top",
                },
                {
                "type": "file",
                "name": "surat_kuasa",
                "title": "Upload File",
                "hideNumber": true,
                "isRequired": true,
                "showPreview": true,
                "allowMultiple": false,
                "acceptedTypes": ".pdf",
                "titleLocation": "top",
                "maxSize": 2048000
                }
                ]
            }
            ],
            "showTitle": false,
            "showCompletedPage": false,
            "showPageNumbers": false,
            "showQuestionNumbers": "off",
            "widthMode": "responsive"
        };

        function sendDataToServer(sender) {
        //send Ajax request to your web server.
            $("#modalPage").modal('hide');
            var json_result = sender.data;

            var data_kirim = {
                "isactive": json_result.active,
                "alamat_perusahaan": json_result.alamat_perusahaan,
                "jenis_penyelenggara": json_result.jenis_penyelenggara,
                "telp_perusahaan": json_result.telp_perusahaan,
                "nama_perusahaan": json_result.nama_perusahaan,
                "npwp_perusahaan": json_result.npwp_perusahaan,
                "email_perusahaan": json_result.email_perusahaan,
                "nib_perusahaan": json_result.nib_perusahaan,
                "surat_kuasa": json_result.surat_kuasa[0].content,
            }

            $.ajax({
                method: 'POST',
                url: '/userman/api/v1/bidder/',
                contentType : 'application/json',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                dataType : 'json',
                data: JSON.stringify(data_kirim),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', 'Basic ' + btoa('rachmatg:P@ssw0rd.2019'));
                    },
                    success: function (data) {
                        swal.fire({
                            title: "Tersimpan !",
                            text: "Data Tersimpan",
                            icon: "success"
                        }).then(function() {
                            location.reload();
                        });
                    },
                    error: function(error) {
                        console.log(error);
                        swal.fire({
                            title: "Error !",
                            text: error.responseText,
                            icon: "error"
                        }).then(function() {
                            location.reload();
                        });
                    }
                });
        }

        function editDataToServer(sender) {
        //send Ajax request to your web server.
            $("#modalPage").modal('hide');
            var json_result = sender.data;
            var data_kirim;
            var url = json_result.surat_kuasa[0].content;
            const isValidUrl = urlString=> {
                var urlPattern = new RegExp('^(https?:\\/\\/)?'+ // validate protocol
                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // validate domain name
                '((\\d{1,3}\\.){3}\\d{1,3}))'+ // validate OR ip (v4) address
                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // validate port and path
                '(\\?[;&a-z\\d%_.~+=-]*)?'+ // validate query string
                '(\\#[-a-z\\d_]*)?$','i'); // validate fragment locator
                return !!urlPattern.test(urlString);
            }

            if (isValidUrl(url) == true) {
                var data_kirim = {
                    "isactive": json_result.active,
                    "alamat_perusahaan": json_result.alamat_perusahaan,
                    "jenis_penyelenggara": json_result.jenis_penyelenggara,
                    "telp_perusahaan": json_result.telp_perusahaan,
                    "nama_perusahaan": json_result.nama_perusahaan,
                    "npwp_perusahaan": json_result.npwp_perusahaan,
                    "email_perusahaan": json_result.email_perusahaan,
                    "nib_perusahaan": json_result.nib_perusahaan,
                }
            }else{
                var data_kirim = {
                    "isactive": json_result.active,
                    "alamat_perusahaan": json_result.alamat_perusahaan,
                    "jenis_penyelenggara": json_result.jenis_penyelenggara,
                    "telp_perusahaan": json_result.telp_perusahaan,
                    "nama_perusahaan": json_result.nama_perusahaan,
                    "npwp_perusahaan": json_result.npwp_perusahaan,
                    "email_perusahaan": json_result.email_perusahaan,
                    "nib_perusahaan": json_result.nib_perusahaan,
                    "surat_kuasa": json_result.surat_kuasa[0].content,
                }
            }

            $.ajax({
                method: 'PUT',
                url: '/userman/api/v1/bidder/'+id_global+'/',
                contentType : 'application/json',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                dataType : 'json',
                data: JSON.stringify(data_kirim),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Basic ' + btoa('rachmatg:P@ssw0rd.2019'));
                },
                success: function (data) {
                    swal.fire({
                        title: "Tersimpan !",
                        text: "Data Tersimpan",
                        icon: "success"
                    }).then(function() {
                        location.reload();
                    });
                },
                error: function(error) {
                    console.log(error);
                    swal.fire({
                        title: "Error !",
                        text: error.responseText,
                        icon: "error"
                    }).then(function() {
                        location.reload();
                    });
                }
            });
        }

        $( "#tambah_data" ).on( "click", function() {
            $("#tombol_batal").show();
            $("#tombol_simpan").show();
            $("#tombol_simpan").attr("data_tricky", 1);
            var_survey = new Survey.Model(json);
            var_survey.onComplete.add(sendDataToServer);
            $("#form_survey").Survey({ model: var_survey });
            $('.modal-title').text('Tambah Perusahaan')
            $('#myModal').modal('show');
        });

        $("#bidderlist").on("click",".download", function(){
            var item = myvm.gridOptions.selectedItems();
            
            if (item && item.length > 0 && item[0].surat_kuasa) {
                var skPengangkatanURL = item[item.length - 1].surat_kuasa;
                console.log(skPengangkatanURL);
                $('#myModal').modal('show');
                $('.modal-title').text("PDF Viewer");
                PDFObject.embed(skPengangkatanURL, "#form_survey", {height: "100vh"});
            } else {
                console.log("error: salah data");
            }
        });

        $("#bidderlist").on("click",".edit", function(){
            $("#tombol_batal").show();
            $("#tombol_simpan").show();
            $("#tombol_simpan").attr("data_tricky", 3);
            
            var item = myvm.gridOptions.selectedItems();
            var data_mentah = item[item.length - 1];
            id_global = data_mentah.id;

            var data_fill = {
                "alamat_perusahaan": data_mentah.alamat_perusahaan,
                "jenis_penyelenggara": data_mentah.jenis_penyelenggara,
                "telp_perusahaan": data_mentah.telp_perusahaan,
                "nama_perusahaan": data_mentah.nama_perusahaan,
                "npwp_perusahaan": data_mentah.npwp_perusahaan,
                "email_perusahaan": data_mentah.email_perusahaan,
                "nib_perusahaan": data_mentah.nib_perusahaan,
                "surat_kuasa": data_mentah.surat_kuasa
            }

            var_survey_edit = new Survey.Model(json);
            var_survey_edit.data = data_fill;
            var_survey_edit.onComplete.add(editDataToServer);
            $("#form_survey").Survey({ model: var_survey_edit });
            $('.modal-title').text('Edit Perusahaan')
            $('#myModal').modal('show');
        });

        $("#bidderlist").on("click",".delete", function(){
            var item = myvm.gridOptions.selectedItems();
            var id = item[item.length - 1];

            Swal.fire({
                icon: 'warning',
                title: 'Hapus data',
                text: "Ingin menghapus data ini ?",
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Hapus',
                cancelButtonText: 'Batal',
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        method: 'DELETE',
                        url: '/userman/api/v1/bidder/'+id.id+'/',
                        contentType : 'application/json',
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        dataType : 'json',
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader('Authorization', 'Basic ' + btoa('rachmatg:P@ssw0rd.2019'));
                        },
                        success: function (data) {
                            swal.fire({
                                title: "Deleted !",
                                text: "",
                                icon: "success"
                            }).then(function() {
                                location.reload();
                                swal.fire({
                                    title: "Error !",
                                    text: error.responseText,
                                    icon: "error"
                                }).then(function() {
                                    location.reload();
                                });
                            });
                        },
                        error: function(error) {
                            console.log(error);
                        }
                    });
                } else if (result.isDenied) {

                }
            })
        });
    
        $("#bidderlist").on("click",".tambah_perwakilan", function(){
            $("#tombol_batal").show();
            $("#tombol_simpan").show();
            $("#tombol_simpan").attr("data_tricky", 2);

            var item = myvm.gridOptions.selectedItems();
            console.log(item);
            var data_mentah = item[item.length - 1];
            id_perusahaan = data_mentah.id;

            $.ajax({
            method: 'GET',
            url: '/userman/api/v1/Users/?bidder='+id_perusahaan+'&isactive=true',
            contentType : 'application/json',
            dataType : 'json',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Basic ' + btoa('rachmatg:P@ssw0rd.2019'));
                },
                success: function (data) {
                    console.log(data)
                    if(data.count == 3){
                        alert("data yang aktif lebih dari 3 tidak bisa menambahkan");
                    // }else if(data.count == 0){
                    //     alert("anda belum membuat akun bidder/seluruh akun bidder sudah terdaftar");
                    }else{
                        persiapan_perwakilan(data_mentah);
                    }
                },
                error: function(error) {
                    console.log(error);
                }
        });

        });

        $("#bidderlist").on("click",".lihat_perwakilan", function(){
            var item = myvm.gridOptions.selectedItems();
            console.log(item);
            var data_mentah = item[item.length - 1];
            id_perusahaan = data_mentah.id;

            nampilin_list(data_mentah);
        });
    });

    function simpan(){
        var dataInfoValue = $("#tombol_simpan").attr("data_tricky");
        switch(dataInfoValue) {
            case "1":
                var_survey.doComplete();
                break;
            case "2":
                var_survey_perwakilan.doComplete();
                break;
            case "3":
                var_survey_edit.doComplete();
                break;
            case "4":
                var_perwakilan.doComplete();
                break;
            default:
        }
    }

    function batal(){
        var_survey.clear();
        $('#myModal').modal('hide');
    }

    // nampilin datatables
    
    //persiapan
    function nampilin_list(data_perusahaan){
        $.ajax({
            method: 'GET',
            url: '/userman/api/v1/Users/?bidder='+data_perusahaan.id,
            contentType : 'application/json',
            dataType : 'json',
                success: function (data) {
                    if (data.count == 0) {
                        alert("anda belum menambahkan akun perwakilan")
                    } else {
                        persiapan_data_list(data, data_perusahaan);
                    }
                },
                error: function(error) {
                    console.log(error);
                }
        });
    }

    function persiapan_data_list(persiapan_data_list, data_perusahaan){
        var data_array = [];
        for (let index = 0; index < persiapan_data_list.count; index++) {
            const element1 = persiapan_data_list.results[index];
            
            data_array.push({
                "id_perusahaan": data_perusahaan.id,
                "id_username": element1.id,
                "username": element1.username,
                "nama_lengkap": element1.nama_lengkap,
                "isactive": element1.isactive,
                "nama_perusahaan": data_perusahaan.nama_perusahaan,
                "surat_kuasa": data_perusahaan.surat_kuasa,
                "jenis_penyelenggara": data_perusahaan.jenis_penyelenggara
            });

            if (index == persiapan_data_list.count-1) {
                nampilin_modal(data_array);
            }
        }

    }

    function nampilin_modal(data_array) {

        var table = $('#bidderlist2').DataTable();
        table.destroy();

        $('#bidderlist2').DataTable({
            "paging": true,
            "responsive": true,
            "ordering": true,
            "info": true,
            "autoWidth": true,
            "searching": true,
            "data": data_array,
            "columns": [
                { "data": "username" },
                { "data": "nama_lengkap" },
                { "data": "nama_perusahaan" },
                { "data": "jenis_penyelenggara", render: function(data, type){
                    //menyesuaikan key data dengan valuenya
                    // console.log(data);
                    switch (data) {
                        case "JSB":
                            return "Jaringan Bergerak Seluler"
                            
                            break;
                        
                        case "JKS":
                            return "Jaringan Tetap Lokal Packet Switched"
                            
                            break;
                    
                        default:
                            return "Tidak diketahui"

                            break;
                    }
                }},
                { "data": "isactive", render: function(data, type){
                    //menyesuaikan key data dengan valuenya
                    if (data == true) {
                        return "Aktif"
                    } else {
                        return "Nonaktif"
                    }
                }},
                // { "data": "surat_kuasa" },
                { 'data': "surat_kuasa", "render": function (data, type, row, meta) { return '<div class="btn-group"><button type="button" class="btn btn-info file_perwakilan" ><i class="fa-solid fa-file"></i></button></div>' } },
                { 'data': "", "render": function (data, type, row, meta) { return '<div class="btn-group"><button type="button" class="btn btn-primary edit_perwakilan" ><i class="fa fa-pen" aria-hidden="true"></i></button> <button type="button" class="btn btn-danger hapus_perwakilan" ><i class="fa fa-eraser" aria-hidden="true"></i></button> </div>' } },
            ],
        });

        $('#bidderlist2 tbody').on( 'click', '.file_perwakilan', function () {
            $("#tombol_batal").hide();
            $("#tombol_simpan").hide();
            var tr = $(this).closest('tr');
            var data =$('#bidderlist2').DataTable().row( tr ).data();

            var skPengangkatanURL = data.surat_kuasa;
            $('#myModal').modal('show');
            $('.modal-title').text("PDF Viewer");
            PDFObject.embed(skPengangkatanURL, "#form_survey", {height: "100vh"});
        });

        $('#bidderlist2 tbody').on( 'click', '.edit_perwakilan', function () {
            var tr = $(this).closest('tr');
            var data =$('#bidderlist2').DataTable().row( tr ).data();

            var id = data.id_username

            $.ajax({
            method: 'GET',
            url: '/userman/api/v1/Users/'+id+'/',
            contentType : 'application/json',
            dataType : 'json',
                success: function (data) {
                    var_data_perwakilan = data
                    update_perwakilan();
                },
                error: function(error) {
                    console.log(error);
                }
            });
        });

        $('#bidderlist2 tbody').on( 'click', '.hapus_perwakilan', function () {
            var tr = $(this).closest('tr');
            var data =$('#bidderlist2').DataTable().row( tr ).data();

            var id = data.id_username

            Swal.fire({
                icon: 'warning',
                title: 'Hapus data',
                text: "Ingin menghapus data ini ?",
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Hapus',
                cancelButtonText: 'Batal',
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                    method: 'GET',
                    url: '/userman/api/v1/Users/'+id+'/',
                    contentType : 'application/json',
                    dataType : 'json',
                        success: function (data) {
                            delete_perwakilan(data);
                        },
                        error: function(error) {
                            console.log(error);
                        }
                    });
                } else if (result.isDenied) {

                }
            })
        });

        $('.modal-title2').text('List Perwakilan')
        $('#myModal2').modal('show');
    }

    // update bidder linked
    function persiapan_perwakilan(data_mentah){
        var array_choice = [];
        id_perusahaan = data_mentah.id;
        nama_perusahaan = data_mentah.nama_perusahaan;
        //data perwaklian perusahaan
        $.ajax({
            method: 'GET',
            url: '/userman/api/v1/Users/?user_type=B',
            contentType : 'application/json',
            dataType : 'json',
                success: function (data) {
                    var data_json_perwakilan = data.results;

                    for (let index = 0; index < data_json_perwakilan.length; index++) {
                        const element = data_json_perwakilan[index];
                        if (element.bidder == null) {
                            data_obj = {
                                "value": element.id,
                                "text": element.nama_lengkap
                            }
                            array_choice.push(data_obj);
                        }

                        if (index == data_json_perwakilan.length-1) {
                            perwakilan_(array_choice, id_perusahaan, nama_perusahaan);
                        }
                    }
                },
                error: function(error) {
                    console.log(error);
                }
        });

        
    }

    function perwakilan_(data_array, id_perusahaan, nama_perusahaan){
        var json = {
            "title": "Pertanyaan",
            "logoPosition": "right",
            "pages": [
                {
                "name": "page1",
                "elements": [
                {
                "type": "dropdown",
                "readOnly": true,
                "name": "nama_perusahaan",
                "title": "Nama Perusahaan",
                "hideNumber": true,
                "isRequired": true,
                "titleLocation": "top",
                "choices": [{"value": id_perusahaan, "text": nama_perusahaan}],
                },
                {
                "type": "dropdown",
                "name": "id_perwakilan",
                "startWithNewLine": false,
                "title": "Pilih perwakilan",
                "hideNumber": true,
                "isRequired": true,
                "choices": data_array,
                }
                ]
            }
            ],
            "showTitle": false,
            "showCompletedPage": false,
            "showPageNumbers": false,
            "showQuestionNumbers": "off",
            "widthMode": "responsive"
        };

        var data_fill = {
            "nama_perusahaan": id_perusahaan,
        }

        var_survey_perwakilan = new Survey.Model(json);
        var_survey_perwakilan.data = data_fill;
        var_survey_perwakilan.onComplete.add(putDataToServer);
        $("#form_survey").Survey({ model: var_survey_perwakilan });
        $('.modal-title').text('Lihat Perwakilan')
        $('#myModal').modal('show');
    }

    function putDataToServer(sender) {
    //send Ajax request to your web server.
        $("#modalPage").modal('hide');
        var json_result = sender.data;

        console.log(json_result.id_perwakilan);

        $.ajax({
            method: 'GET',
            url: '/userman/api/v1/Users/'+json_result.id_perwakilan+'/',
            contentType : 'application/json',
            dataType : 'json',
                success: function (data) {
                    data_perwakilan = data;
                    update_user(json_result.nama_perusahaan);
                },
                error: function(error) {
                    console.log(error);
                }
        });
    }

    function update_user(id_bidder){
        var data_kirim = {
            "isactive": data_perwakilan.isactive,
            "email": data_perwakilan.email,
            "username": data_perwakilan.username,
            "mobile_number": data_perwakilan.mobile_number,
            "nama_lengkap": data_perwakilan.nama_lengkap,
            "user_type": data_perwakilan.user_type,
            "masaberlaku1": data_perwakilan.masaberlaku1,
            "masaberlaku2": data_perwakilan.masaberlaku2,
            "bidder": id_bidder
        }

        $.ajax({
            method: 'PUT',
            url: '/userman/api/v1/Users/'+data_perwakilan.id+'/',
            contentType : 'application/json',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            dataType : 'json',
            data: JSON.stringify(data_kirim),
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Basic ' + btoa('rachmatg:P@ssw0rd.2019'));
            },
            success: function (data) {
                swal.fire({
                    title: "Tersimpan !",
                    text: "Data Tersimpan",
                    icon: "success"
                }).then(function() {
                    location.reload();
                });
            },
            error: function(error) {
                console.log(error);
                swal.fire({
                    title: "Error !",
                    text: error.responseText,
                    icon: "error"
                }).then(function() {
                    location.reload();
                });
            }
        });
    }

    function delete_perwakilan(data_mentah){
        var data_kirim = {
            "isactive": data_mentah.isactive,
            "email": data_mentah.email,
            "username": data_mentah.username,
            "mobile_number": data_mentah.mobile_number,
            "nama_lengkap": data_mentah.nama_lengkap,
            "user_type": data_mentah.user_type,
            "masaberlaku1": data_mentah.masaberlaku1,
            "masaberlaku2": data_mentah.masaberlaku2,
            "bidder": null,
        }

        $.ajax({
            method: 'PUT',
            url: '/userman/api/v1/Users/'+data_mentah.id+'/',
            contentType : 'application/json',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            dataType : 'json',
            data: JSON.stringify(data_kirim),
            success: function (data) {
                swal.fire({
                    title: "Tersimpan !",
                    text: "Data Tersimpan",
                    icon: "success"
                }).then(function() {
                    location.reload();
                });
            },
            error: function(error) {
                console.log(error);
                swal.fire({
                    title: "Error !",
                    text: error.responseText,
                    icon: "error"
                });
            }
        });
    }

    function update_perwakilan(){
        $("#tombol_batal").show();
        $("#tombol_simpan").show();
        $("#tombol_simpan").attr("data_tricky", 4);

        var json = {
            "title": "Pertanyaan",
            "logoPosition": "right",
            "pages": [
                {
                "name": "page1",
                "elements": [
                {
                "type": "dropdown",
                "name": "isactive",
                "title": "Status Akun",
                "hideNumber": true,
                "isRequired": true,
                "titleLocation": "top",
                "choices": [{"value": true, "text": "Aktif"}, {"value": false, "text": "Nonaktif"}],
                },
                ]
            }
            ],
            "showTitle": false,
            "showCompletedPage": false,
            "showPageNumbers": false,
            "showQuestionNumbers": "off",
            "widthMode": "responsive"
        };

        var_perwakilan = new Survey.Model(json);
        var_perwakilan.onComplete.add(perwakilanDataToServer);
        $("#form_survey").Survey({ model: var_perwakilan });
        $('.modal-title').text('Lihat Perwakilan')
        $('#myModal').modal('show');
    }

    function perwakilanDataToServer(sender) {
    
        var data_kirim = {
            "isactive": sender.data.isactive,
            "email": var_data_perwakilan.email,
            "username": var_data_perwakilan.username,
            "mobile_number": var_data_perwakilan.mobile_number,
            "nama_lengkap": var_data_perwakilan.nama_lengkap,
            "user_type": var_data_perwakilan.user_type,
            "masaberlaku1": var_data_perwakilan.masaberlaku1,
            "masaberlaku2": var_data_perwakilan.masaberlaku2,
        }

        $.ajax({
            method: 'PUT',
            url: '/userman/api/v1/Users/'+var_data_perwakilan.id+'/',
            contentType : 'application/json',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            dataType : 'json',
            data: JSON.stringify(data_kirim),
            success: function (data) {
                swal.fire({
                    title: "Tersimpan !",
                    text: "Data Tersimpan",
                    icon: "success"
                }).then(function() {
                    location.reload();
                });
            },
            error: function(error) {
                console.log(error);
                swal.fire({
                    title: "Error !",
                    text: error.responseText,
                    icon: "error"
                });
            }
        });
    }
</script>

<script src="/static/js/knockout.js"></script>
<script type="text/javascript" src="/static/js/koGrid.js"></script>
{% endblock  %}
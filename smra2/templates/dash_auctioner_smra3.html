{% extends 'new_index/base1.html' %}
{% load widget_tweaks %}
{% load static %}
{% load judul_tags %}

{% block extrahead %}
<style>
  .pvtTotal, .pvtTotalLabel, .pvtGrandTotal {display: none}
</style>
{% endblock %}
{% block navbar %}
{% include 'new_index/parts/navbar_kosong.html' %}
{% endblock %}

{% block konten_isi %}
<div class="row jdl_atas_background">
  <div class="col-md-12"> 
      <span class="jdl_atas">SMRA &gt; Putaran Seleksi</span>
  </div>

  <br><br>
            {% if user_type == "C" %}
            {% add_judul_auctioner user.id auctioner.item_lelang.id "/smra2/dashboard_auctioner/" %}
            {% elif user_type == "V" %}
            {% add_judul_viewer user.id item_lelang.id "/smra2/dashboard_auctioner/" %}
            {% elif user_type == "A" %}
            {% add_judul_admin user.id item_lelang.id "/smra2/dashboard_auctioner/" %}
            {% endif %}
</div>
<div class="col-md-12" style="padding-left:30px; padding-top:30px; padding-right:30px;">
  <div class="col-md-12">
    <div class="row">
      <div class="col-md-12">
        


        <div class="tab-content mt-2">
          <div class="tab-pane fade show active" id="tabone" role="tabpanel">
            <div class="tab-content mt-2">
              <div class="tab-pane fade show active" id="tabone" role="tabpanel">
                
                
                <div class="row row1 pt-3 " data-bind='foreach: allItems()'>
                  <div class="card w-100">
                    <div class="card-header" style="background-color:#032056;">

                      <span class="text-white h1 text-bold" >Pita Frekuensi Radio</span> <span  data-bind='text: band' class="text-white h1 text-bold"></span><br><br>
                                        </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-3">
                          <div class="card">
                            <div class="card-header bg-dark text-center">
                                <i class="fa fa-arrow-rotate-right"></i>&nbsp;&nbsp;<b>Putaran</b>
                            </div>
                            <div class="card-body text-center"  style="height:150px">
                             
                              <span scope="row1" class="text-bold h1 text-black" data-bind='text: round'></span>
                               <!-- ko if: khusus()==true -->
                               <br><span scope="row1" class="text-bold h5 btn bg-danger">Khusus</span>
                               <!-- /ko -->
                               <!-- ko if: status_round() == 'INIT' --> 
                               <br><span scope="row1" class="text-bold h5 btn bg-black">INISIASI</span>
                               <!-- /ko --> 
                               <!-- ko if: status_round() == 'START' --> 
                               <br><span scope="row1" class="text-bold h5 btn bg-green">MULAI</span>
                               <!-- /ko -->
                               <!-- ko if: status_round() == 'STOP' --> 
                               <br><span scope="row1" class="text-bold h5 btn bg-blue">VALIDASI</span>
                               <!-- /ko -->
                               <!-- ko if: status_round() == 'WAIT' --> 
                               <br><span scope="row1" class="text-bold h5 btn bg-warning">TUNGGU</span>
                               <!-- /ko -->
                               <!-- ko if: status_round() == 'FINAL' --> 
                               <br><span scope="row1" class="text-bold h5 btn bg-red">SELESAI</span>
                               <!-- /ko -->
                               <!-- ko if: status_round() == 'CLOSED' --> 
                               <br><span scope="row1" class="text-bold h5 btn bg-gray">BERSAMBUNG</span>
                               <!-- /ko -->
                            </div>
                          </div>
                        </div>
                       
                        
                        <div class="col-3">
                          <div class="card">
                            <div class="card-header bg-dark text-center">
                              <i class="fa fa-hourglass"></i>&nbsp;&nbsp;<b>Mulai</b>
                            </div>
                            <div class="card-body text-center" style="height:150px">
                              <span scope="row1" class="text-bold h3 text-blue" data-bind='html: mulai1'></span>
                            </div>
                          </div>
                        </div>
                        <div class="col-3">
                          <div class="card">
                            <div class="card-header bg-dark text-center">
                              <i class="fa fa-hourglass-end"></i>&nbsp;&nbsp;<b>Berakhir</b>
                            </div>
                            <div class="card-body text-center"  style="height:150px">
                              <span scope="row1" class="text-bold h3 text-blue" data-bind='html: selesai1'></span>
                            </div>
                          </div>
                        </div>
                        <div class="col-3">
                          <div class="card">
                            <div class="card-header bg-dark text-center">
                              <i class="fa fa-hourglass-half"></i>&nbsp;&nbsp;<b>Sisa</b>
                            </div>
                            <div class="card-body text-center"  style="height:150px">
                              <!-- ko if: status_round() !== "FINAL" -->
                              <!-- ko if: status_round() == 'WAIT' -->   
                              <span scope="row1" class="text-bold h1 text-green" data-bind='html: $root.sisa'></span>
                              <!-- /ko -->
                              <!-- ko if: status_round() !== 'WAIT' -->
                              <span scope="row1" class="text-bold h1 text-red" data-bind='html: $root.sisa'></span>
                              <!-- /ko -->
                              <!-- /ko -->
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-4">
                            <div class="card">
                              
                              
                              <div class="card-header bg-dark text-center">
                                <i class="fa fa-tv"></i>&nbsp;&nbsp;<b>Background Process</b>
                              </div>
                              <div class="card-body bg-dark">
                                <div class="row">
                                  <div class="col-6">
                                    <span data-bind="visible:$root.connected" class=" btn bg-green">Websocket ON <i class="fas fa-link"></i></span>
                                    
                                  </div>
                                  <div class="col-6">
                                    <span data-bind="visible:$root.connected2" class="btn bg-green">Background Process ON <i class="fas fa-link"></i></span>
                                  </div>
                                </div>
                                <hr>
                                <div class="row" style="height:450px">
                                  <span data-bind="html: $root.terminal" class="h7 text-white"></span>
                                </div>
                              </div>
                              
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card">
                                <div class="card-header bg-dark text-center">
                                    <i class="fa fa-person"></i>&nbsp;&nbsp;<b>Peserta</b>
                                </div>
                                
                                <div class="card-body bg-dark">
                                  <img width="100%"  scope="row1" data-bind="attr:{src: $root.link4 } " />  
                                </div>
                                
                            </div>
                            <div class="card">
                                <div class="card-header bg-dark text-center">
                                    <i class="fa fa-square"></i>&nbsp;&nbsp;<b>Block</b>
                                    <span data-bind="html: $root.link3" class="h7 text-white"></span>
                                </div>
                                
                                <div class="card-body bg-dark">
                                  <img width="100%"  scope="row1" data-bind="attr:{src: $root.link3 } " />  
                                </div>
                                
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card">
                                <div class="card-header bg-dark text-center">
                                    <i class="fa fa-file-contract"></i>&nbsp;&nbsp;<b>Penawaran Tertinggi </b>
                                </div>
                                
                                <div class="card-body bg-dark">
                                    <img width="100%"  scope="row1" data-bind="attr:{src: $root.link1 } " />  
                                </div>
                                
                            </div>
                            <div class="card">
                                <div class="card-header bg-dark text-center">
                                    <i class="fa fa-percent"></i>&nbsp;&nbsp;<b>Prosentase Kenaikan</b>
                                </div>
                                 
                                <div class="card-body bg-dark">
                                  <img width="100%"  scope="row1" data-bind="attr:{src: $root.link2 } " /> 
                                </div>
                                
                            </div>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>
            </div>
          </div>

          


        </div>
      </div>
    </div>
  </div>
</div>
</div>
  
{% endblock %}
  {% block script %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js" integrity="sha512-efAcjYoYT0sXxQRtxGY37CKYmqsFVOIwMApaEbrxJr4RwqVVGw8o+Lfh/+59TU07+suZn1BWq4fDl5fdgyCNkw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="/static/js/currency.js"></script>
  <script src="/static/js/countdown.js"></script>
  <script>
    function komapperToKO(src) {
      var mapped = [];
      var map = function (obj) {
          obj = ko.unwrap(obj);
          if (obj === null
              || obj === undefined
              || typeof obj === "number"
              || typeof obj === "boolean"
              || typeof obj === "string"
              || typeof obj === "function"
              ) {
              return obj;
          }
          else if (obj instanceof Array) {
              var ares = [];
              for (var i = 0; i < obj.length; i++) {
                  ares.push(map(obj[i]));
              }
              return ko.observableArray(ares);
          }
          else {
              var prev = mapped.find(x => x.src === obj);
              if (prev)
                  return prev.dst;
              var res = {};
              mapped.push({ src: obj, dst: res });
  
              for (var p in obj) {
                  var pv = ko.unwrap(obj[p]);
                  if (typeof pv === "function") {
                      res[p] = pv;
                  }
                  else if (pv instanceof Array) {
                      res[p] = map(pv);
                  }
                  else {
                      res[p] = ko.observable(map(pv));
                  }
              }
              return res;
          }
      }
      return map(src);
    }
  </script>
  <script src="/static/js/eauctions_modal.js"></script>
  <script>
  $(document).ready(function () {   
          
      ko.bindingHandlers.inputmask =
      {
        init: function (element, valueAccessor, allBindingsAccessor) {
            var mask = valueAccessor();    
            var observable = mask.value;
            if (ko.isObservable(observable)) {
                $(element).on('focusout change', function () {
                    if ($(element).inputmask('isComplete')) {
                        observable($(element).val());
                    } else {
                        observable(null);
                    }
                });
            }
            $(element).inputmask(mask);
        },
        update: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
            var mask = valueAccessor();
            var observable = mask.value;
            if (ko.isObservable(observable)) {
                var valuetoWrite = observable();
                $(element).val(valuetoWrite);
            }
        }
       };
   
    // select2
    //$('#nmlelang').select2();

    var hasilModel = moment.locale('id'); 
    var viewModel = {
      connected1: ko.observable(false),
      connected2: ko.observable(false),
      terminal: ko.observable("wait"),
      time_for_start:  ko.observable(false),
      eli_sekarang: ko.observable(), // Initially blank
      eli_sebelum: ko.observable(), // Initially blank
      first: ko.observable(true),
      time_start: ko.observable(),
      time_end: ko.observable(),
      sisa_time: ko.observable(120*60),
      allItems: ko.observableArray([]),
      bidItems: ko.observableArray([]),
      allItems: ko.observableArray([]),
      allHasil: ko.observableArray([]),
      mulai: ko.observable(),
      selesai: ko.observable(),
      periode: ko.observable(),
      status: ko.observable(),
      error_message: ko.observable(),
      waspada: ko.observable(false),
      putaran: ko.observable(),
      last_putaran: ko.observable(1),
      mulai_putaran: ko.observable(),
      sisa: ko.observable(),
      link1: ko.observable('/smra2/hasil_chart_maxmin/'+id+'/'),
      link2: ko.observable('/smra2/hasil_persen/'+id+'/'),
      link3: ko.observable('/smra2/hasil_block/'+id+'/'),
      link4: ko.observable('/smra2/hasil_peserta/'+id+'/'),
     

      start: function(data) {
        id = data.item_lelang()
        Swal.fire({
          title: 'Apakah Anda Yakin Untuk Memulai Lelang?',
          text: "Proses Lelang Siap Dilaksanakan!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, lanjutkan!'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax('/smra2/api/v1/round_smra/'+data.item()+'/start/',   // request url
            {
              success: function (data, status, xhr) {// success callback function
                if (data.status!="OK")
                  Swal.fire(data.status)
                load_table(id);
              }
            });
          }
        })     
      },

      stop: function(data) {
        id = data.item_lelang()
        Swal.fire({
          title: 'Yakin akan men-stop?',
          text: "Ini tidak dapat diulang!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, lanjutkan!'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax('/smra2/api/v1/round_smra/'+data.item()+'/stop/',   // request url
            {
              success: function (data, status, xhr) {// success callback function
                load_table(id);
              }
            });
          }
        })
      },

      restart: function(data) {
        id = data.item_lelang()
        Swal.fire({
          title: 'Yakin akan me-reset putaran?',
          text: "Ini tidak dapat diulang!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, lanjutkan!'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax('/smra2/api/v1/round_smra/'+data.item()+'/reset_round/',   // request url
            {
              success: function (data, status, xhr) {// success callback function
                load_table(id);
              }
            });
          }
        })
      },

      pause: function(data) {
        id = data.item_lelang()
        Swal.fire({
          title: 'Yakin akan pause?',
          text: "Ini tidak dapat diulang!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, lanjutkan!'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax('/smra2/api/v1/round_smra/'+data.item()+'/pause/',   // request url
            {
              success: function (data, status, xhr) {// success callback function
                load_table(id);
              }
            });
          }
        });
      },

      resume: function(data) {
        id = data.item_lelang()
        Swal.fire({
          title: 'Yakin akan me-resume?'+data.item(),
          text: "Ini tidak dapat diulang!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, lanjutkan!'
        }).then((result) => {
          if (result.isConfirmed) { 
            $.ajax('/smra2/api/v1/round_smra/'+data.item()+'/resume/',   // request url
              {
                success: function (data, status, xhr) {// success callback function
                  load_table(id);
                }
              });
          }
        })
      },

      resumelanjut: function(data) {
        id = data.item_lelang()
        Swal.fire({
          title: 'Yakin akan me-resume?'+data.item(),
          text: "Ini tidak dapat diulang!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, lanjutkan!'
        }).then((result) => {
          if (result.isConfirmed) { 
            $.ajax('/smra2/api/v1/round_smra/'+data.item()+'/resumelanjut/',   // request url
              {
                success: function (data, status, xhr) {// success callback function
                  load_table(id);
                }
              });
          }
        })
      },

      close: function(data) {        
        id = data.item_lelang()
        Swal.fire({
          title: 'Yakin akan menghentikan lelang?',
          text: "Ini tidak dapat diulang!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, lanjutkan!'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax('/smra2/api/v1/round_smra/'+data.item()+'/close/',   // request url
            {
              success: function (data, status, xhr) {// success callback function
                load_table(id);
              }
            });
          }
        })
      },

      init: function(data) {

        id = data.item_lelang()
        Swal.fire({
          title: 'Yakin akan menginisiasi ke awal?',
          text: "Ini tidak dapat diulang!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, lanjutkan!'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax('/smra2/api/v1/round_smra/'+data.item()+'/init/',   // request url
            {
                
                success: function (data, status, xhr) {// success callback function
                load_table(id);
              }
            });
          }
        })
      },

      loadData_hasil: function(id,item=null) {
        $.ajax({
            url: '/smra2/auctioner_hasil/'+ id +'/',
            method: "GET",
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
              return data;
            }
        });
      },

      loadData_hasil_maxmin: function(id,item=null) {
        $.ajax({
            url: '/smra2/auctioner_hasil_maxmin/'+ id +'/',
            method: "GET",
            xhrFields: {
                withCredentials: true
            },
            success: function (data) {
              return data;
            }
        });
      },
    };
    
    ko.applyBindings(viewModel);
   
    function pad(num) {
      return ("0"+num).slice(-2);
    }
    function hhmmss(secs) {
      var minutes = Math.floor(secs / 60);
      secs = secs%60;
      var hours = Math.floor(minutes/60)
      minutes = minutes%60;
      return `${pad(hours)}:${pad(minutes)}:${pad(secs)}`;
      // return pad(hours)+":"+pad(minutes)+":"+pad(secs); for old browsers
    }
    /*
    countdown.setLabels(
      '| detik| menit| jam|',
      '| detik| menit| jam|',
      ', dan ');
    */
    countdown.setLabels(
      '|s|m|h|',
      '|s|m|h|',
      ' : ');
    function formatDate1(date) {
        return moment(date).format('DD-MMM-YYYY').toUpperCase();
       
    }
   
    function load_table(id) {
      //viewModel.allItems([]);
      putaran = 1;//viewModel.putaran();
      
      $.ajax('/smra2/api/v1/sum_round_smra/?item_lelang='+id,   // request url
      {
        success: function (data, status, xhr) {// success callback function
          tunggal=false
          hasil = new Array();
          viewModel.time_for_start(0);
          viewModel.sisa(0);
          data.results.forEach(function(item,index,arr) {
           
           if (index == 0)
           { 
              
              link1="/smra2/hasil_chart_maxmin/"+id+"/";
              link2="/smra2/hasil_persen/"+id+"/";
              link3="/smra2/hasil_block/"+id+"/";
              link4="/smra2/hasil_peserta/"+id+"/";
            
              viewModel.link1(link1);
              viewModel.link2(link2);
              viewModel.link3(link3);
              viewModel.link4(link4);
              

              
              if (item.status_round=="START") {
                end = moment(item.selesai1);
                
                viewModel.time_for_start(end);
              
                start = moment(item.mulai1);
              
                item.sisa= moment.duration(end.diff(start) ).seconds();
              
                viewModel.sisa(item.sisa);
                item.mulai1="<span class='h5'>"+moment(item.mulai1).format('DD MMM YYYY').toUpperCase()+"</span><br><span class='h2 text-bold'>"+moment(item.mulai1).format('HH:mm:ss').toUpperCase()+"</span><br><span class='h6'>WIB</span>";
                item.selesai1="<span class='h5'>"+moment(item.selesai1).format('DD MMM YYYY').toUpperCase()+"</span><br><span class='h2 text-bold'>"+moment(item.selesai1).format('HH:mm:ss').toUpperCase()+"</span><br><span class='h6'>WIB</span>";

              }
              if (item.status_round=="WAIT")
              {
                end = moment(item.selesai1);
                start = moment(item.mulai1);
                viewModel.time_for_start(start);
              
                item.mulai1="<span class='h5'>"+moment(item.mulai1).format('DD MMM YYYY').toUpperCase()+"</span><br><span class='h2 text-bold'>"+moment(item.mulai1).format('HH:mm:ss').toUpperCase()+"</span><br><span class='h6'>WIB</span>";
                item.selesai1="<span class='h5'>"+moment(item.selesai1).format('DD MMM YYYY').toUpperCase()+"</span><br><span class='h2 text-bold'>"+moment(item.selesai1).format('HH:mm:ss').toUpperCase()+"</span><br><span class='h6'>WIB</span>";

              }
              if (item.status_round=="INIT")
              {
                item.mulai1="<span class='h5'>-</span>";
                item.selesai1="<span class='h5'>-</span>";
                item.sisa="<span class='h5'>-</span>";
                viewModel.mulai("");
                viewModel.selesai("");
                viewModel.sisa("");

              }
              if (item.status_round=="STOP")
              {
                item.mulai1="<span class='h5'>-</span>";
                item.selesai1="<span class='h5'>-</span>";
                item.sisa="<span class='h5'>-</span>";
                viewModel.mulai("");
                viewModel.selesai("");
                viewModel.sisa("");

              }
              if (item.status_round=="CLOSED")
              {
                item.mulai1="<span class='h5'>-</span>";
                item.selesai1="<span class='h5'>-</span>";
                item.sisa="<span class='h5'>-</span>";
                viewModel.mulai("");
                viewModel.selesai("");
                viewModel.sisa("");

              }
              if (item.status_round=="FINAL")
              {
                item.mulai1="<span class='h5'>-</span>";
                item.selesai1="<span class='h5'>-</span>";
                item.sisa="<span class='h5'>-</span>";

              }
              
              item.band = item.band[0]['band']+index;
              item.min_price = currency(item.min_price,{ symbol:"Rp.",separator: ",", decimal: "."}).format();
              item.prev_price = currency(item.prev_price,{ symbol:"Rp.",separator: ",", decimal: "."}).format();
           }
                
          });

          v = komapperToKO(data.results);
          viewModel.allItems(v);
          viewModel.waspada(false);
        }
      });
    }

    var id = $('#nmlelang').val();
    function loadData_hasil(id) {
      $.ajax({
          url: 'smra2/api/v1/auctioneer_hasil/?item_lelang='+ id,
          method: "GET",
          xhrFields: {
              withCredentials: true
          },
          success: function (data) {
           // viewModel.allItems(data.results)
          }
      });
    }
    function loadData_Putaran(id) {
      $.ajax({
          url: '/smra/jadwal_putaran2/'+id + '/',
          method: "GET",
          xhrFields: {
              withCredentials: true
          },
          success: function (data) {
              var table = $("#t_putaran");
              table.empty();
              table.append(data);
          }
      });
    }
    
    function loadData_pemenang(id) {
      $.ajax({
          url: '/smra2/auctioner_highest/'+id + '/',
          method: "GET",
          xhrFields: {
              withCredentials: true
          },
          success: function (data) {
              var table = $("#t_pemenang");
              table.empty();
              table.append(data);
          }
      });
    }
   
    load_table(id);

    loadData_Putaran(id);
    //loadData_hasil(id);
    //loadData_pemenang(id);
 
    $("#createBidder").on("click",function(){
      $.fn.modal.Constructor.prototype._enforceFocus = function() {};
      $('#modalPage').modal('show');
      $('.modal-title').text("Masukkan Harga");
      viewModel.bidItems(viewModel.allItems());
    });

    setInterval(function() {
      if (viewModel.time_for_start()!=0) {
        sekarang = moment();
       
        if (viewModel.time_for_start().diff(sekarang)<30000)
          viewModel.waspada(true);
        if (sekarang <= viewModel.time_for_start())
          viewModel.sisa(countdown(sekarang, viewModel.time_for_start(), countdown.HOURS|countdown.MINUTES|countdown.SECONDS))
        else
          viewModel.sisa("0s")
      }
    }, 1000);
});

</script>
{% endblock %}

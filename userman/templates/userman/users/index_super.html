{% extends "../../base.html" %}
{% block extrahead %}
<link rel="stylesheet" type="text/css" href="/static/css/koGrid.css" >
<link rel="stylesheet" type="text/css" href="/static/css/survey-ui.min.css" >

<style>
    .navbar {
        height: 64px;
        background-color: #007bff;
      }
    .brand-img {
        height: 51.94px;
    }
    .container-fluid {
        padding-right: 0px;
        padding-left: 0px;
    }
    .footer_bg {
        background: url(/static/img/portal/background-footer.png);
    }
    .banner {
        background: url(/static/img/portal/background-slider.png);
        height: 768px;
        width: 100%;
    }
    .logobesar {
        position: absolute;
        left: 85;
        top: 209;
    }
    .portal_penjelasan {
        position: absolute;
        left: 85;
        top: 411;
        width: 643;
    }
    .button_yuk_mulai {
        position: absolute;
        left: 85;
        top: 520;
        width: 133;
    }
    .sdppi_side {
        position: absolute;
        right: 0;
        top: 652;
    }
    .bi {
        vertical-align: -.125em;
        pointer-events: none;
        fill: currentColor;
      }
      .nav-flush .nav-link {
        border-radius: 0;
      }
    .gridStyle {
        border: 1px solid rgb(255, 255, 255);
        width: 100%; 
        height: 300px;
        float: left;
    }
    .KgTopPanel{
        background-color: white;
    }
    .KgFooterPanel{
        background-color: white;
    }
    .kgRow.Even{
        background-color: #edf5fd;
    }
    .KgRow.Even.selected{
	background-color: rgb(189, 208, 203);
	}
</style>
{% endblock %}
{% block navbar %}
{% include "component/navbar_super.html" %}
{% endblock %}
{% block content %}
<div class="row" style="
margin-left: 0px;
margin-right: 0px;
">
    <div class="col col-md-1 bg-light" style="width:4.5rem;">
        <ul class="nav nav-pills nav-flush flex-column mb-auto text-center pt-5">
            <li class="nav-item">
                <a href="/" class="nav-link py-3 border-bottom" aria-current="page" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Home">
                    <i class="fa fa-home"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="/userman/users/" class="nav-link active py-3 border-bottom" aria-current="page" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Users Management">
                    <i class="fa fa-user"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="/userman/bidder/" class="nav-link py-3 border-bottom" aria-current="page" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Bidder Management">
                    <i class="fa fa-users"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="/userman/tim_lelang/" class="nav-link py-3 border-bottom" aria-current="page" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Auctioner Management">
                    <i class="fa fa-plus-circle"></i>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link py-3 border-bottom" aria-current="page" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Viewer Management">
                    <i class="fa fa-user-secret"></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Place Bid">
                    <i class="fa fa-usd"></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Activity">
                    <i class="fa fa-line-chart"></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Round Summary">
                    <i class="fa fa-tasks"></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Posted Result">
                    <i class="fa fa-id-card"></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Messages">
                    <i class="fa fa-comments"></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Schedules">
                    <i class="fa fa-calendar"></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Download">
                    <i class="fa fa-download"></i>
                </a>
            </li>
            <li>
                <a href="/accounts/logout/" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Logout">
                    <i class="fa fa-power-off"></i>
                </a>
            </li>
        </ul>
    </div>
    <div class="col col-md-11">
        <h4 style="display:none;" id="data_id_tricky"></h4>
        <h4 style="display:none;" id="data_id_tricky_edit"></h4>
        <!-- <h4 style="display:none;" id="data_id_tricky_bidder"></h4> -->
        <div class="row">
            <div class="col" style="">
                <div class="card" style="top: 20px;">
                    <div style="font-size: 24px; font-weight: bold; color: #007bff; padding: 20px">
                        Master Data
                    </div>
                </div>
            </div>
        </div>
        <div class="row" style="margin-right: 15px">
            <div class="card mt-5" style="left: 15px;" id="management_block">
                <div class="card-header" style="background-color: white;">
                    <div class="h4 float-start">List Akun Terdaftar</div>
                    <div hx-target="#management_block" hx-swap="outerHTML" onload="myFunction()">
                        <button hx-get="/userman/users/add/" type="button" class="btn btn-secondary float-end" style="background-color: #fff;color: #007bff;border-color: #007bff; font-size:14px;"><i class="fa-solid fa-plus-circle"></i> Tambah Baru</button>
                        <button hx-get="/userman/users/add/bidder" type="button" class="btn btn-secondary float-end" id="editpindahpage" style="display:none;">Edit</button>
                        <button hx-get="/userman/users/user_view" type="button" class="btn btn-secondary float-end" id="lihatpindahpage_admin" style="display:none;">biodata_admin</button>
                        <button hx-get="/userman/users/user_edit" type="button" class="btn btn-secondary float-end" id="lihatpindahpage_admin_edit" style="display:none;">biodata_admin</button>
                        <button hx-get="/userman/users/user_lelang_edit" type="button" class="btn btn-secondary float-end" id="lihatpindahpage_lelang_edit" style="display:none;">biodata_admin>biodata_tim_lelang_view</button>
                        <button hx-get="/userman/users/user_lelang_view" type="button" class="btn btn-secondary float-end" id="lihatpindahpage_lelang_view" style="display:none;">biodata_admin>biodata_tim_lelang_view</button>
                    </div>
                </div>
                <div class="card-body" style="padding-left: 0px; padding-right: 0px;">
                    <div id="bidderlist" class="gridStyle" data-bind="koGrid: gridOptions"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block footer %}
{% include "component/footer.html" %}
{% endblock %}
{% block modal %}
<div class="modal fade" id="modalPage" aria-hidden="true" aria-labelledby="modalPage" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div id="form_survey"></div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block script %}

<script>
(function () {
    'use strict'
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl)
    })
  })()
</script>

<script>
    $(document).ready(function() {
        
        function mainVm(){
            var self = this; 
            this.myData = ko.observableArray([]);
        
            this.filterOptions = {
                filterText: ko.observable(""),
                useExternalFilter: true
            };
            this.mySelectedData = ko.observableArray([]);

            this.pagingOptions = {
                pageSizes: ko.observableArray([5, 10, 15]),
                pageSize: ko.observable(5),
                totalServerItems: ko.observable(0),
                currentPage: ko.observable(1)     
            };
        
            this.setPagingData = function(data, page, pageSize){	
                // var pagedData = data.slice((page - 1) * pageSize, page * pageSize);
                // console.log(data.results);
                var data_mentah = data.results;
                var data_array = [];

                console.log(data_mentah);

                function myFunction(item, index) {
                    var test = {
                        "index": index+1,
                        "isactive": manipulasi_data_status(item.isactive),
                        "user_type": manipulasi_data_jenis(item.user_type),
                        "masaberlaku": manipulasi_data_date(item.masaberlaku1, item.masaberlaku2),
                        "id": item.id,
                        "email": item.email,
                        "mobile_number": item.mobile_number,
                        "nama_lengkap": item.nama_lengkap,
                        "username": item.username,
                        "password": item.password,
                    }
                    data_array.push(test);
                }

                function manipulasi_data_date(data_date1, data_date2){
                    return data_date1+" - "+data_date2;
                }

                function manipulasi_data_status(data_status){
                    if (data_status == true) {
                        return "Aktif";
                    } else {
                        return "Nonaktif";
                    }

                }

                function manipulasi_data_jenis(data_jenis){
                    switch(data_jenis) {
                        case "A":
                            return "Admin";
                            break;
                        case "B":
                            return "Bidder";
                            break;
                        case "C":
                            return "Auctioneer";
                            break;
                        case "V":
                            return "Viewer";
                            break;
                    }
                }

                data_mentah.forEach(myFunction);
                self.myData(data_array);
                self.pagingOptions.totalServerItems(data.count);
            };
        
            this.getPagedDataAsync = function (pageSize, page, searchText) {
                setTimeout(function () {
                    var data;
                    if (searchText) {
                        var ft = searchText.toLowerCase();
                        $.getJSON('/userman/api/v1/Users/?format=json&limit=' + pageSize + '&offset=' + (page-1)*pageSize, function (largeLoad) {		
                            data = largeLoad.filter(function(item) {
                                return JSON.stringify(item).toLowerCase().indexOf(ft) != -1;
                            });
                            self.setPagingData(data,page,pageSize);
                        });            
                    } else {
                        $.getJSON('/userman/api/v1/Users/?format=json&limit=' + pageSize + '&offset=' + (page-1)*pageSize, function (largeLoad) {
                            self.setPagingData(largeLoad,page,pageSize);
                        });
                    }
                }, 100);
            };

            self.filterOptions.filterText.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });   

            self.pagingOptions.pageSizes.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });
            self.pagingOptions.pageSize.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });
            self.pagingOptions.totalServerItems.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });
            self.pagingOptions.currentPage.subscribe(function (data) {
                self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage(), self.filterOptions.filterText());
            });
        
            self.getPagedDataAsync(self.pagingOptions.pageSize(), self.pagingOptions.currentPage());
            this.gridOptions = {
                data: self.myData,
                enablePaging: true,
                displaySelectionCheckbox: false,
                showColumnMenu: false,
                pagingOptions: self.pagingOptions,
                filterOptions: self.filterOptions,
                selectedItems: self.mySelectedData,
                columnDefs: [
                    {field: 'index', displayName: 'No'},
                    {field: 'username', displayName: 'Username'},
                    {field: 'password', displayName: 'Password'},
                    {field: 'nama_lengkap', displayName: 'Nama Pengguna'},
                    {field: 'user_type', displayName: 'Jenis User'},
                    {field: 'masaberlaku', displayName: 'Masa Berlaku'},
                    {field: 'mobile_number', displayName: 'Telepon Pendaftar'},
                    {field: 'isactive', displayName: 'Status'},
                    {field: 'id', displayName: 'Biodata', cellTemplate:'<div style="display: flex; justify-content: center;"><button class="lihat badge  mr-1" data-bind=\"attr: {\'id\': $data.getProperty($parent)}\" value="Lihat" style="background-color: #edf5fd; color: 0062FF; border-radius:10px; border-color: #007bff;"><i class="fa fa-eye" aria-hidden="true"></i>Lihat</button></div>'},
                    {field: 'id', displayName: 'Kirim Ulang', cellTemplate:'<div class="kirim" data-bind=\"attr: {\'id\': $data.getProperty($parent)}\" >Kirim</div>'},
                    {field: 'id', displayName: 'Aksi', cellTemplate:'<div style="display: flex; justify-content: center;"><button class="edit badge  mr-1" data-bind=\"attr: {\'id\': $data.getProperty($parent)}\" value="Edit" style="border-color:white;"><i class="fa fa-pen" style="color: #0068f0;"></i></button>&nbsp;&nbsp;<button class="delete badge mr-1" data-bind=\"attr: {\'id\': $data.getProperty($parent)}\" value="Delete" style="border-color:white;"><i class="fa-regular fa-trash-can" style="color: #ff0040;"></i></button></div>'}
                ],
                afterSelectionChange: function(){ 
                    console.log(self.mySelectedData());
                }
            };	
        };
        
        var myvm = new mainVm();
        ko.applyBindings(myvm, document.getElementById("management_block"));
        
        var json = {
            "title": "Pertanyaan",
            "logoPosition": "right",
            "pages": [
                {
                "name": "page1",
                "elements": [
                    {
                    "type": "text",
                    "name": "nama_lengkap",
                    "title": "Nama Pengguna"
                    },
                    {
                    "type": "text",
                    "inputType": "email",
                    "name": "email",
                    "title": "E-Mail",
                    "inputType": "email"
                    },
                    {
                    "type": "text",
                    "name": "username",
                    "type": "text",
                    "title": "Username",
                    },
                    {
                    "inputType": "password",
                    "name": "password",
                    "type": "text",
                    "startWithNewLine": false,
                    "title": "Password",
                    "inputType": "password"
                    },
                    {
                    "inputType": "PhoneNumber",
                    "type": "text",
                    "name": "mobile_number",
                    "title": "No.Handphone",
                    },
                    {
                    "type": "boolean",
                    "startWithNewLine": false,
                    "name": "isactive",
                    "title": "Status Aktivasi"
                    }
                ]
             }
            ],
            "showTitle": false,
            "showCompletedPage": false,
            "showPageNumbers": false,
            "showQuestionNumbers": "off",
            "questionTitleLocation": "left",
            "completeText": "Simpan",
            "widthMode": "responsive"
        };

        $("#createBidder").on("click",function(){
            $.fn.modal.Constructor.prototype._enforceFocus = function() {};
            $('#modalPage').modal('show');
            $('.modal-title').text("Tambah User");
            Survey.StylesManager.applyTheme("darkblue");
            var surveyDialog = new Survey.Model(json,"form_survey");
            surveyDialog.onComplete.add(sendDataToServer);
            //surveyDialog.render("form_survey");
        });

        function sendDataToServer(sender) {
        //send Ajax request to your web server.
            $("#modalPage").modal('hide');
            const results = JSON.stringify(sender.data);

            $.ajax({
                method: 'POST',
                url: 'http://iotekno.id:8000/userman/api/v1/Users/',
                contentType : 'application/json',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                dataType : 'json',
                data: results,
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('Authorization', 'Basic ' + btoa('rachmatg:P@ssw0rd.2019'));
                    },
                    success: function (data) {
                        // console.log(data);
                        location.reload();
                    },
                    error: function(error) {
                        console.log(error);
                        //$('#retValStatus').text("Ada masalah pada pengiriman data...");
                    }
                });
        }

        let id_global;

        $("#bidderlist").on("click",".lihat", function(){
            var item = myvm.gridOptions.selectedItems();
            
            const myButton_bidder = document.getElementById('editpindahpage');
            const myButton_admin = document.getElementById('lihatpindahpage_admin');
            const myButton_timlelang = document.getElementById('lihatpindahpage_lelang_view');
            const label_tricky = document.getElementById('data_id_tricky');

            var id = item[item.length - 1];
            id_global = id.id;
            label_tricky.setAttribute('text', id_global);

            tipe = id.user_type;
            switch(tipe) {
                case "A":
                    myButton_admin.click();
                    break;
                case "B":
                    // code block
                    myButton_bidder.click();
                    break;
                case "C":
                    // code block
                    myButton_timlelang.click();
                    break;
                case "V":
                    // code block
                    alert("masih belum bisa");
                    break;
            }
            
            // myButton.click();
        });

        $("#bidderlist").on("click",".edit", function(){
            var item = myvm.gridOptions.selectedItems();
            const myButton = document.getElementById('editpindahpage');
            const myButton_admin = document.getElementById('lihatpindahpage_admin_edit');
            const myButton_timlelang = document.getElementById('lihatpindahpage_lelang_edit');
            const label_tricky = document.getElementById('data_id_tricky');

            var id = item[item.length - 1];
            id_global = id.id;
            label_tricky.setAttribute('text', id_global);

            tipe = id.user_type;
            switch(tipe) {
                case "A":
                    myButton_admin.click();
                    break;
                case "B":
                    // code block
                    myButton.click();
                    break;
                case "C":
                    // code block
                    myButton_timlelang.click();
                    break;
                case "V":
                    // code block
                    alert("masih belum bisa");
                    break;
            }
        });

        function editDataToServer(sender) {
        //send Ajax request to your web server.
            $("#modalPage").modal('hide');
            const results = JSON.stringify(sender.data);

            $.ajax({
                method: 'PUT',
                url: 'http://iotekno.id:8000/userman/api/v1/Users/'+id_global+'/',
                contentType : 'application/json',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                dataType : 'json',
                data: results,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Basic ' + btoa('rachmatg:P@ssw0rd.2019'));
                },
                success: function (data) {
                    // console.log(data);
                    location.reload();
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }

        $("#bidderlist").on("click",".delete", function(){
            var item = myvm.gridOptions.selectedItems();
            var id = item[item.length - 1];

            Swal.fire({
                icon: 'warning',
                title: 'Hapus data',
                text: "Ingin menghapus data ini ?",
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Hapus',
                cancelButtonText: 'Batal',
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        method: 'DELETE',
                        url: 'http://iotekno.id:8000/userman/api/v1/Users/'+id.id+'/',
                        contentType : 'application/json',
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        dataType : 'json',
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader('Authorization', 'Basic ' + btoa('rachmatg:P@ssw0rd.2019'));
                        },
                        success: function (data) {
                            swal.fire({
                                title: "Deleted !",
                                text: "",
                                icon: "success"
                            }).then(function() {
                                location.reload();
                            });
                        },
                        error: function(error) {
                            console.log(error);
                        }
                    });
                } else if (result.isDenied) {

                }
            })
        });
    });
</script>
<script src="/static/js/knockout.js"></script>
<script type="text/javascript" src="/static/js/koGrid.js"></script>
<script src="/static/js/survey.knockout.min.js"></script>
{% endblock %}
